*Work in progress...*

# Halite 3 bot

![Main image](/images/0.png)

Данный бот создан в ходе соревнования [Halite3](https://2018.halite.io/learn-programming-challenge/game-overview)
и занял [72 место (bogdandm)](https://2018.halite.io/user/?user_id=3020). 
Это было мое первое соревнование такого рода, 
которое дало возможность узнать массу новых приемов оптимизации и алгоритмов.

Многие решения были подобранны по наитию и не имеют ни какой математической базы под собой.

## Краткие правила соревнования

*Официальные правила доступны по ссылке [Halite3](https://2018.halite.io/learn-programming-challenge/game-overview).*

Игра происходит на квадратном закольцованном поле, которое состоит из клеток с ресурсами (галитом).
Цель игры - добыть как можно ресурсов при помощи кораблей. 
Корабли строятся на верфи и тратят ресурсы для передвижения по клеткам (стоимость зависит от кол-ва ресурсов на клетке).
Для того чтобы добытые ресурсы зачислились игроку, корабль должен вернуться на верфь или дропофф (специальная постройка).
Если в радиусе 4х клеток от корабля находится 2+ вражеских корабля (корабль вдохновлен), то он получает двукратный бонус к добыче.

## Алгоритм

### Общая идея

В целом всю задачу игры можно разделить на составляющие:

1. Определение оптимальных клеток для добычи
2. Поиск путей к этим клеткам
3. Поиск оптимального пути для разгрузки
4. Нахождение потенциальных мест для постройки дропоффов
5. Стратегия постройки новых кораблей
6. Избегание столкновений с вражескими кораблями и охота за полностью загруженными кораблями

Весь алгоритм построен на поле потенциалов, собирающемся из нескольких компонентов.

### Основной цикл

Каждый ход состоит из одних и тех же стадий (не считая стадии инициализации в начале игры):

1. Поиск позиции для дропоффа и привязка корабля для его постройки к этой позиции

2. Перемещение корабля из шага (1)

3. Высчитывание маски для поля потенциалов (глобальной)

    * [Маска (1)](#mask-1) для вражеских кораблей, включает в себя в штраф в малом радиусе и бонус радиусе вдохновения 
    
    * Размытая отрицательная [маска (2)](#mask-2) союзных кораблей
    
    * [Маска (3)](#mask-3) усредненных по площади ресурсов (размытие по Гауссу)
    
    * Копия карты ресурсов с обрезанными минимумами (создавали лишний шум в конце игры, 
      когда эффективней было стоять на месте, а не пытаться добыть 5-10 единиц ресурса)
    
4. Обход всех своих кораблей

    1. Перемещение корабля домой при определенном объеме ресурсов. Путь искался алгоритмом A* 
       с модификацией для избегания вражеских кораблей (считаются как клетки с очень высокой стоимостью перемещения)
    
    2. Поиск цели для тарана в округе
    
    3. Высчитывание маски для каждого корабля в отдельности
        
        * Штраф для клетки, являющейся целью (в т.ч. с предыдущего хода) другого корабля 
        
        * Ценность ресурса уменьшается с расстоянием согласно формуле `расстояние ^ k`, где `1.0 < k < 2.0`.
          Таким образом, при приближении к первоначальной клетке ценность некоторых клеток, находящихся по пути, 
          будет перевешивать и корабль будет "расчищать" дорогу к большим скоплениям ресурсов, 
          чтобы ему было проще возвратиться на базу
          
        * Маска вражеских кораблей и вдохновения обрезается в радиусе больше заданного вокруг корабля, 
          т.к. нет смысла учитывать корабли, которые переместятся быстрее, чем наш корабль достигнет цели
          
        * Все маски накладываются на карту ресурсов
        
        * Для клетки, на которой стоит корабль, применяется бонус добычи ресурсов
        
        * Найденная клетка с максимальным потенциалом становится целью данного корабля. 
          Если потенциал меньше определенного предела, корабль движется в случайном направлении или стоит на месте.
    
5. Цели кораблей преобразуются в список их ходов
    
    1. Получаем словарь `(корабль -> список направлений для движения)`
    
    2. Пока можно безопасно двигать корабли двигаем их
    
    3. Если можно поменять местами 2 корабля - меняем
    
    4. Возвращаемся к шагу 2
    
6. Производим корабли при выполнении определенных условий

## Картинки

### Mask 1

Маска вдохновения и штрафа вокруг вражеских кораблей. 
Для поиска вдохновения используется наложение заранее созданных масок с последуюшей обрезкой 
максимумов/минимумов до необходимых значений. Это позволяет вычислять всю маску за один проход по кораблям. 

![](/images/1.png)

### Mask 2

Размытая отрицательная маска союзных кораблей 

![](/images/2.png)

### Mask 3

Размытые ресурсы

![](/images/3.png)

### Dropoff 1

Поиск места для дропоффа

![](/images/10.png)

![](/images/11.png)